<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"
  >
  <title>复式记账网页程序</title>
  <style>
    :root {
      --bg-body: #0f172a;
      --bg-app: #f9fafb;
      --bg-card: #ffffff;
      --bg-card-soft: #f3f4f6;
      --border-subtle: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --accent: #3b82f6;
      --accent-soft: #dbeafe;
      --danger: #ef4444;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.18);
      --radius-lg: 14px;
      --radius-md: 10px;
      --radius-sm: 6px;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      width: 100%;
      overflow-x: hidden;
    }

    body {
      margin: 0;
      padding: 0;
      min-height: 100dvh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top left, #1e293b 0, #020617 60%),
        radial-gradient(circle at bottom right, #0f766e 0, #020617 55%);
      color: var(--text-main);
      -webkit-text-size-adjust: 100%;
    }

    .app {
      width: 100%;
      max-width: 960px;
      margin: 0 auto;
      min-height: 100dvh;
      background: var(--bg-app);
      border-radius: 0;
      box-shadow: none;
      border: none;

      /* 顶部 + 灵动岛 safe-area，底部 + Home Indicator safe-area */
      padding-top: calc(18px + env(safe-area-inset-top));
      padding-right: max(24px, env(safe-area-inset-right));
      padding-bottom: calc(28px + env(safe-area-inset-bottom));
      padding-left: max(24px, env(safe-area-inset-left));
    }

    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
    }

    .app-title-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    h1 {
      font-size: 19px;
      font-weight: 600;
      margin: 0;
      letter-spacing: 0.02em;
      color: #020617;
    }

    .app-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #0f172a;
      color: #e5e7eb;
      font-size: 11px;
      font-weight: 500;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.45);
    }

    .badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.35);
    }

    .layout-grid {
      display: grid;
      /* 左：汇率设置，右：录入账单（更宽） */
      grid-template-columns: minmax(0, 1fr) minmax(0, 2.1fr);
      gap: 16px;
      margin-bottom: 16px;
    }

    @media (max-width: 900px) {
      .layout-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    fieldset {
      margin: 0 0 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      background: var(--bg-card);
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
      padding: 10px 12px 12px;
    }

    legend {
      padding: 0 6px;
      font-weight: 600;
      font-size: 13px;
      color: #111827;
    }

    label {
      display: inline-flex;
      align-items: center;
      margin: 4px 6px 4px 0;
      font-size: 12px;
      color: #111827;
      white-space: nowrap;
    }

    label span {
      margin-right: 4px;
    }

    input,
    select,
    button {
      padding: 4px 8px;
      margin: 2px 4px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 12px;
      font-family: inherit;
      background-color: #ffffff;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.4);
    }

    input[type="date"],
    input[type="month"] {
      padding-inline-end: 2px;
    }

    button {
      background: var(--accent);
      color: #ffffff;
      border: none;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.06s ease, box-shadow 0.06s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      font-weight: 500;
      -webkit-appearance: none;
    }

    button:hover {
      background: #2563eb;
      transform: translateY(-0.5px);
      box-shadow: 0 4px 10px rgba(37, 99, 235, 0.35);
    }

    button:active {
      transform: translateY(0);
      box-shadow: none;
    }

    button.secondary {
      background: #e5e7eb;
      color: #111827;
      border: 1px solid #d1d5db;
    }

    button.secondary:hover {
      background: #d1d5db;
      box-shadow: 0 3px 8px rgba(148, 163, 184, 0.4);
    }

    button.small {
      padding: 2px 8px;
      font-size: 11px;
      background: #f3f4f6;
      color: #111827;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      box-shadow: none;
    }

    button.small:hover {
      background: #e5e7eb;
      box-shadow: 0 2px 4px rgba(148, 163, 184, 0.6);
    }

    .btn-danger {
      background: #fee2e2;
      color: var(--danger);
      border: 1px solid #fecaca;
    }

    .btn-danger:hover {
      background: #fecaca;
      box-shadow: 0 2px 6px rgba(248, 113, 113, 0.7);
    }

    .small {
      font-size: 12px;
      color: var(--text-muted);
    }

    .auto {
      color: #2563eb;
      font-size: 11px;
    }

    .summary {
      background: linear-gradient(to right, #eef2ff, #e0f2fe);
      padding: 10px 14px;
      margin-bottom: 14px;
      border: 1px solid #d1d5db;
      border-radius: var(--radius-lg);
      box-shadow: 0 1px 4px rgba(15, 23, 42, 0.08);
      display: flex;
      flex-wrap: wrap;
      gap: 10px 18px;
      align-items: center;
    }

    .summary-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      font-weight: 500;
      color: #0f172a;
    }

    .summary-label {
      font-size: 12px;
      color: var(--text-muted);
    }

    .summary-value {
      font-size: 14px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    .summary-value.net {
      background: #ecfdf3;
      border-color: #bbf7d0;
      color: #166534;
    }

    .summary-value.budget {
      background: #fefce8;
      border-color: #facc15;
      color: #854d0e;
    }

    .summary-value.base {
      background: #eff6ff;
      border-color: #93c5fd;
      color: #1d4ed8;
      font-size: 12px;
    }

    .summary-value.consume {
      background: #fef2f2;
      border-color: #fecaca;
      color: #b91c1c;
    }

    .section-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px 12px;
      margin-bottom: 4px;
    }

    .section-column {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .hint-box {
      margin-top: 4px;
      padding: 6px 8px;
      background: #f9fafb;
      border-radius: var(--radius-sm);
      border: 1px dashed #d1d5db;
      font-size: 11px;
      color: var(--text-muted);
      line-height: 1.5;
    }

    .note-input {
      flex: 1;
      min-width: 220px;
    }

    .form-actions {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 8px;
      background: #ffffff;
    }

    th,
    td {
      border: 1px solid #e5e7eb;
      padding: 6px 6px;
      text-align: left;
      font-size: 12px;
      white-space: nowrap;
    }

    th {
      background: #f3f4f6;
      font-weight: 600;
      color: #4b5563;
    }

    tbody tr:nth-child(odd) {
      background-color: #f9fafb;
    }

    tbody tr:hover {
      background-color: #e5f0ff;
    }

    td:nth-child(4) {
      text-align: right;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .table-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .table-toolbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .hidden {
      display: none;
    }

    /* 表格横向滚动容器（移动端） */
    .table-container {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .table-container table {
      min-width: 720px;
    }

    /* iPhone 等窄屏优化：<= 600px */
    @media (max-width: 600px) {
      .app {
        padding-top: calc(10px + env(safe-area-inset-top));
        padding-right: max(10px, env(safe-area-inset-right));
        padding-bottom: calc(18px + env(safe-area-inset-bottom));
        padding-left: max(10px, env(safe-area-inset-left));
        border-radius: 0;
        box-shadow: none;
      }

      /* 关键：在窄屏不要强制 720px，避免整页被缩小 */
      .table-container table {
        min-width: 100%;
      }

      .app-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      h1 {
        font-size: 17px;
      }

      .app-subtitle {
        font-size: 11px;
      }

      .badge {
        font-size: 10px;
        padding: 3px 8px;
        box-shadow: none;
      }

      .layout-grid {
        grid-template-columns: minmax(0, 1fr);
        gap: 12px;
      }

      fieldset {
        padding: 8px 8px 10px;
      }

      legend {
        font-size: 12px;
      }

      label {
        width: 100%;
        margin: 2px 0;
        font-size: 11px;
        white-space: normal;
      }

      .section-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }

      .section-row label {
        width: 100%;
      }

      input,
      select {
        width: 100%;
        max-width: 100%;
      }

      .note-input {
        min-width: 0;
      }

      .summary {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
      }

      .summary-item {
        font-size: 12px;
      }

      .summary-value {
        font-size: 12px;
      }

      .table-toolbar {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
      }

      .table-toolbar-right {
        width: 100%;
        justify-content: flex-start;
      }

      button {
        padding: 5px 10px;
        font-size: 11px;
      }

      button.small {
        padding: 2px 8px;
        font-size: 10px;
      }

      th,
      td {
        padding: 4px 4px;
        font-size: 11px;
      }
    }

    /* 特别窄（老款 iPhone / 小窗口） */
    @media (max-width: 360px) {
      .badge {
        display: none;
      }

      h1 {
        font-size: 16px;
      }

      .summary {
        padding: 8px 10px;
      }
    }

    /* iPhone 15 Pro / 15 Pro Max 等 393x852 DPR=3 的机型微调 */
    @media screen and (width: 393px) and (height: 852px) and (-webkit-device-pixel-ratio: 3) {
      .app {
        padding-top: calc(12px + env(safe-area-inset-top));
        padding-bottom: calc(20px + env(safe-area-inset-bottom));
      }

      h1 {
        font-size: 18px;
      }

      .summary {
        gap: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="app-title-group">
        <h1>复式记账网页程序</h1>
        <div class="app-subtitle">轻量级 · 本地存储 · 多币种支持</div>
      </div>
      <div class="badge">
        <span class="badge-dot"></span>
        <span>本地运行 · 数据只保存在浏览器中</span>
      </div>
    </header>

    <!-- 汇总信息 -->
    <div class="summary" id="summary">
      <div class="summary-item">
        <span class="summary-label">统计月份</span>
        <input type="month" id="summaryMonth"
               style="font-size:12px;padding:2px 6px;border-radius:999px;border:1px solid #d1d5db;">
      </div>
      <div class="summary-item">
        <span class="summary-label">预算余额</span>
        <span class="summary-value budget" id="budgetTotal">0</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">消费额</span>
        <span class="summary-value consume" id="consumeTotal">0</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">总资产余额</span>
        <span class="summary-value net" id="netTotal">0</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">当前基准货币</span>
        <span class="summary-value base">
          <span id="baseCurrencyLabel">JPY</span>
        </span>
      </div>
    </div>

    <!-- 上半部分：左汇率、右录入（录入更宽） -->
    <div class="layout-grid">
      <!-- 左：汇率设置 -->
      <div>
        <fieldset>
          <legend>汇率设置</legend>

          <div class="section-column">
            <div class="section-row">
              <label>
                <span>基准货币：</span>
                <select id="baseCurrency" style="width:90px;">
                  <option value="JPY" selected>JPY</option>
                  <option value="RMB">RMB</option>
                  <option value="USD">USD</option>
                  <option value="EUR">EUR</option>
                </select>
              </label>
              <span class="small">作为统计时的统一货币，可随时切换</span>
            </div>

            <div class="section-row">
              <label>
                <input type="radio" name="rateMode" value="auto" checked>
                <span>自动获取示例汇率</span>
              </label>
              <span class="small">（使用免费 API，可能因网络原因失败）</span>
            </div>

            <div class="section-row">
              <label>
                <input type="radio" name="rateMode" value="manual">
                <span>手动设置汇率</span>
              </label>
              <span class="small">（手动设置优先级最高）</span>
            </div>

            <div id="manualRateArea" class="hidden">
              <div class="section-row">
                <label>
                  <span>币种：</span>
                  <select id="manualCurrencyInput" style="width:90px;">
                    <option value="">选择币种</option>
                    <option value="JPY">JPY</option>
                    <option value="RMB">RMB</option>
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                  </select>
                </label>
                <label>
                  <span>1 单位该币种 =</span>
                  <input type="number" step="0.0001" id="manualRateInput" style="width:90px;">
                  <span id="baseCurrencyInline">JPY</span>
                </label>
                <button type="button" id="addManualRateBtn">添加 / 更新汇率</button>
              </div>
              <div class="small">
                已设置汇率（手动）：<span id="manualRateList"></span>
              </div>
            </div>

            <div class="hint-box">
              说明：统计时优先使用「手动汇率」；若没有手动值，则尝试使用自动获取的汇率；两者都没有时，按 1 处理。<br>
              所有数据和设置会保存在浏览器的 localStorage 中，刷新页面不会丢失（同一浏览器生效）。
            </div>
          </div>
        </fieldset>
      </div>

      <!-- 右：录入表单（更宽） -->
      <div>
        <fieldset>
          <legend>录入账单</legend>

          <form id="entryForm">
            <div class="section-row">
              <label>
                <span>分类：</span>
                <select id="category">
                  <option value="出">出</option>
                  <option value="入">入</option>
                </select>
              </label>

              <label>
                <span>账户类型：</span>
                <select id="accountType">
                  <option value="消费">消费</option>
                  <option value="现金">现金</option>
                  <option value="共同资产">共同资产</option>
                  <option value="存款">存款</option>
                  <option value="预算">预算</option>
                  <option value="日信">日信</option>
                  <option value="中信">中信</option>
                </select>
              </label>

              <label>
                <span>金额：</span>
                <input type="number" id="amount" step="0.01" required style="width:110px;">
              </label>

              <label>
                <span>货币：</span>
                <select id="currency">
                  <option value="JPY" selected>JPY</option>
                  <option value="RMB">RMB</option>
                  <option value="USD">USD</option>
                  <option value="EUR">EUR</option>
                </select>
              </label>
            </div>

            <div class="section-row">
              <label>
                <span>记账时间：</span>
                <input type="date" id="recordDate">
              </label>
              <label>
                <span>账单发生时间：</span>
                <input type="date" id="occurDate">
              </label>
              <span class="small">（发生时间默认为今天，可修改）</span>
            </div>

            <div class="section-row">
              <label style="flex:1; align-items:flex-start;">
                <span>备注：</span>
                <input type="text" id="note" class="note-input" placeholder="例如：午饭、房租、水电…" />
              </label>
            </div>

            <div class="hint-box">
              规则说明：<br>
              1）现金 / 共同资产 / 存款 / 日信 / 中信 的「出」自动生成一条「消费 入」记录；<br>
              2）日信 / 中信「出」（信用卡消费）时，自动生成次月 27 日的「出 现金 / 入 信用卡」两条还款记录；<br>
              3）信用卡（日信 / 中信）手动录入时只能选择「出」，「入」需通过自动转记生成。
            </div>

            <div class="form-actions">
              <button type="submit">添加账单</button>
              <button type="button" id="resetFormBtn" class="secondary">重置表单</button>
            </div>
          </form>
        </fieldset>
      </div>
    </div>

    <!-- 账单列表 + 导入导出工具条 -->
    <fieldset>
      <legend>账单列表</legend>

      <div class="table-toolbar">
        <div class="small">
          当前统计仅按发生时间过滤；导出 CSV 将导出所有记录（不受月份筛选影响）。
        </div>
        <div class="table-toolbar-right">
          <button type="button" id="exportBtn" class="small">导出当前账单为 CSV</button>
          <label class="small">
            <span>导入 CSV：</span>
            <input type="file" id="importFile" accept=".csv,text/csv">
          </label>
        </div>
      </div>

      <div class="table-container">
        <table id="recordsTable">
          <thead>
            <tr>
              <th style="min-width:90px;">操作</th>
              <th>分类</th>
              <th>账户类型</th>
              <th>金额</th>
              <th>货币</th>
              <th>记账时间</th>
              <th>发生时间</th>
              <th>备注</th>
              <th>来源</th>
            </tr>
          </thead>
          <tbody id="recordsTbody"></tbody>
        </table>
      </div>
    </fieldset>
  </div>

<script>
(function() {
  // ------- 状态 -------
  let records = [];
  let nextId = 1;
  let nextGroupId = 1; // 一次录入产生的一组记录的 groupId

  const LS_KEY_RECORDS = "de_records";
  const LS_KEY_NEXT_ID = "de_nextId";
  const LS_KEY_BASE = "de_baseCurrency";
  const LS_KEY_MANUAL = "de_manualRates";
  const LS_KEY_RATE_MODE = "de_rateMode";
  const LS_KEY_GROUP = "de_nextGroupId";

  const accountTypesForExpenseMirror = ["现金", "共同资产", "存款", "日信", "中信"];

  const entryForm = document.getElementById("entryForm");
  const categoryEl = document.getElementById("category");
  const accountTypeEl = document.getElementById("accountType");
  const amountEl = document.getElementById("amount");
  const currencyEl = document.getElementById("currency");
  const recordDateEl = document.getElementById("recordDate");
  const occurDateEl = document.getElementById("occurDate");
  const noteEl = document.getElementById("note");
  const resetFormBtn = document.getElementById("resetFormBtn");

  const recordsTbody = document.getElementById("recordsTbody");
  const budgetTotalEl = document.getElementById("budgetTotal");
  const netTotalEl = document.getElementById("netTotal");
  const consumeTotalEl = document.getElementById("consumeTotal");
  const summaryMonthEl = document.getElementById("summaryMonth");

  const baseCurrencyInput = document.getElementById("baseCurrency");
  const baseCurrencyLabel = document.getElementById("baseCurrencyLabel");
  const baseCurrencyInline = document.getElementById("baseCurrencyInline");
  const manualRateArea = document.getElementById("manualRateArea");
  const manualCurrencyInput = document.getElementById("manualCurrencyInput");
  const manualRateInput = document.getElementById("manualRateInput");
  const addManualRateBtn = document.getElementById("addManualRateBtn");
  const manualRateList = document.getElementById("manualRateList");

  const exportBtn = document.getElementById("exportBtn");
  const importFile = document.getElementById("importFile");

  const rateModeRadios = document.querySelectorAll("input[name='rateMode']");

  let manualRates = {};
  let autoRates = {};

  function todayStr() {
    const d = new Date();
    return d.toISOString().slice(0, 10);
  }

  // 默认日期 = 今天；统计月份 = 当前月
  recordDateEl.value = todayStr();
  occurDateEl.value = todayStr();
  if (summaryMonthEl) {
    summaryMonthEl.value = todayStr().slice(0, 7);
  }

  function syncCategoryForAccountType() {
    const acc = accountTypeEl.value;
    if (acc === "消费") {
      categoryEl.value = "入";
      categoryEl.disabled = true;
    } else if (acc === "日信" || acc === "中信") {
      categoryEl.value = "出";
      categoryEl.disabled = true;
    } else {
      categoryEl.disabled = false;
    }
  }
  accountTypeEl.addEventListener("change", syncCategoryForAccountType);

  function getRateMode() {
    for (const r of rateModeRadios) {
      if (r.checked) return r.value;
    }
    return "auto";
  }
  function setRateMode(mode) {
    rateModeRadios.forEach(r => { r.checked = (r.value === mode); });
  }
  function updateRateModeUI() {
    const mode = getRateMode();
    manualRateArea.classList.toggle("hidden", mode !== "manual");
  }

  function renderManualRateList() {
    const entries = Object.entries(manualRates || {});
    if (!entries.length) {
      manualRateList.textContent = "（无）";
      return;
    }
    manualRateList.textContent = entries.map(([c, r]) => `${c}:${r}`).join("；");
  }

  function saveState() {
    try {
      localStorage.setItem(LS_KEY_RECORDS, JSON.stringify(records));
      localStorage.setItem(LS_KEY_NEXT_ID, String(nextId));
      localStorage.setItem(LS_KEY_BASE, baseCurrencyInput.value || "JPY");
      localStorage.setItem(LS_KEY_MANUAL, JSON.stringify(manualRates || {}));
      localStorage.setItem(LS_KEY_RATE_MODE, getRateMode());
      localStorage.setItem(LS_KEY_GROUP, String(nextGroupId));
    } catch (e) {
      console.log("保存到 localStorage 失败：", e);
    }
  }

  function loadState() {
    try {
      const recStr = localStorage.getItem(LS_KEY_RECORDS);
      if (recStr) {
        const arr = JSON.parse(recStr);
        if (Array.isArray(arr)) records = arr;
      }
    } catch(e) { console.log("读取记录失败：", e); }

    const savedNextId = localStorage.getItem(LS_KEY_NEXT_ID);
    if (savedNextId) {
      const n = parseInt(savedNextId, 10);
      if (!isNaN(n) && n > 0) nextId = n;
    } else {
      let maxId = 0;
      records.forEach(r => { if (r.id && r.id > maxId) maxId = r.id; });
      nextId = maxId + 1;
    }

    const savedBase = localStorage.getItem(LS_KEY_BASE);
    if (savedBase) {
      baseCurrencyInput.value = savedBase;
      baseCurrencyLabel.textContent = savedBase;
      baseCurrencyInline.textContent = savedBase;
    }

    try {
      const savedManual = localStorage.getItem(LS_KEY_MANUAL);
      if (savedManual) {
        const obj = JSON.parse(savedManual);
        if (obj && typeof obj === "object") manualRates = obj;
      }
    } catch(e) { console.log("读取手动汇率失败：", e); }

    const savedMode = localStorage.getItem(LS_KEY_RATE_MODE);
    if (savedMode) setRateMode(savedMode);

    const savedGroup = localStorage.getItem(LS_KEY_GROUP);
    if (savedGroup) {
      const g = parseInt(savedGroup, 10);
      if (!isNaN(g) && g > 0) {
        nextGroupId = g;
      }
    } else {
      let maxGroup = 0;
      records.forEach(r => {
        if (typeof r.groupId === "number" && r.groupId > maxGroup) {
          maxGroup = r.groupId;
        }
      });
      nextGroupId = maxGroup + 1;
    }
  }

  async function fetchAutoRates() {
    const base = baseCurrencyInput.value || "JPY";
    try {
      const resp = await fetch("https://open.er-api.com/v6/latest/" + encodeURIComponent(base));
      if (!resp.ok) return;
      const data = await resp.json();
      if (data && data.rates) {
        autoRates = data.rates;
        recomputeSummary();
      }
    } catch (e) {
      console.log("自动获取汇率失败（不影响基本功能）:", e);
    }
  }

  function getRateToBase(currency) {
    const cur = (currency || "").toUpperCase();
    const mode = getRateMode();
    if (manualRates[cur]) return manualRates[cur];
    if (mode === "auto" && autoRates[cur]) return autoRates[cur];
    return 1;
  }

  function addRecord(rec, groupId) {
    rec.id = nextId++;
    if (typeof groupId === "number") {
      rec.groupId = groupId;
    }
    records.push(rec);
    return rec.id;
  }

  function addRecordWithRules(fromForm) {
    const groupId = nextGroupId++;
    const baseRec = {
      category: fromForm.category,
      accountType: fromForm.accountType,
      amount: fromForm.amount,
      currency: fromForm.currency,
      recordDate: fromForm.recordDate,
      occurDate: fromForm.occurDate,
      note: fromForm.note,
      source: fromForm.source || "手动"
    };
    addRecord(baseRec, groupId);

    if (
      baseRec.category === "出" &&
      accountTypesForExpenseMirror.includes(baseRec.accountType)
    ) {
      const expenseRec = {
        category: "入",
        accountType: "消费",
        amount: baseRec.amount,
        currency: baseRec.currency,
        recordDate: baseRec.recordDate,
        occurDate: baseRec.occurDate,
        note: baseRec.note,
        source: "自动:消费对应"
      };
      addRecord(expenseRec, groupId);
    }

    if (
      baseRec.category === "出" &&
      (baseRec.accountType === "日信" || baseRec.accountType === "中信")
    ) {
      const occur = new Date(baseRec.occurDate || baseRec.recordDate || todayStr());
      const year = occur.getFullYear();
      const month = occur.getMonth();
      const nextMonth = (month + 1) % 12;
      const nextYear = year + (nextMonth === 0 ? 1 : 0);
      const repaymentDate = new Date(nextYear, nextMonth, 27);
      const dateStr = repaymentDate.toISOString().slice(0, 10);

      const cashOut = {
        category: "出",
        accountType: "现金",
        amount: baseRec.amount,
        currency: baseRec.currency,
        recordDate: dateStr,
        occurDate: dateStr,
        note: baseRec.note + "（信用卡还款）",
        source: "自动:信用卡还款"
      };
      const cardIn = {
        category: "入",
        accountType: baseRec.accountType,
        amount: baseRec.amount,
        currency: baseRec.currency,
        recordDate: dateStr,
        occurDate: dateStr,
        note: baseRec.note + "（信用卡还款）",
        source: "自动:信用卡还款"
      };

      addRecord(cashOut, groupId);
      addRecord(cardIn, groupId);
    }
  }

  // 用于净资产计算的有符号金额；消费账户不影响资产。
  function getSignedAmount(rec) {
    if (rec.accountType === "消费") {
      return 0;
    }
    const sign = (rec.category === "入") ? 1 : -1;
    return sign * rec.amount;
  }

  function recomputeSummary() {
    let budgetTotalBase = 0;
    let netTotalBase = 0;
    let consumeTotalBase = 0;
    const base = baseCurrencyInput.value || "JPY";
    const monthFilter = summaryMonthEl && summaryMonthEl.value ? summaryMonthEl.value : null;

    function inMonth(rec) {
      if (!monthFilter) return true;
      const d = rec.occurDate || rec.recordDate;
      if (!d) return false;
      return d.slice(0, 7) === monthFilter;
    }

    records.forEach(rec => {
      if (!inMonth(rec)) return;

      const rate = getRateToBase(rec.currency || base);

      if (rec.accountType === "消费") {
        consumeTotalBase += rec.amount * rate; // 消费只看绝对值
        return;
      }

      const signed = getSignedAmount(rec);
      const inBase = signed * rate;

      if (rec.accountType === "预算") {
        budgetTotalBase += inBase;
      }
      netTotalBase += inBase;
    });

    budgetTotalEl.textContent = budgetTotalBase.toFixed(2) + " " + base;
    netTotalEl.textContent = netTotalBase.toFixed(2) + " " + base;
    consumeTotalEl.textContent = consumeTotalBase.toFixed(2) + " " + base;
    baseCurrencyLabel.textContent = base;
    baseCurrencyInline.textContent = base;
  }

  function addCell(tr, text) {
    const td = document.createElement("td");
    td.textContent = text;
    tr.appendChild(td);
    return td;
  }

  function renderTable() {
    recordsTbody.innerHTML = "";

    const displayList = [...records].sort((a, b) => b.id - a.id);

    displayList.forEach(rec => {
      const tr = document.createElement("tr");

      const tdOps = document.createElement("td");
      const editBtn = document.createElement("button");
      editBtn.textContent = "编辑";
      editBtn.className = "small";

      const delBtn = document.createElement("button");
      delBtn.textContent = "删除";
      delBtn.className = "small btn-danger";

      const isAuto = rec.source && rec.source.startsWith("自动");
      if (isAuto) {
        editBtn.disabled = true;
        editBtn.title = "自动生成记录不可编辑";
      } else {
        editBtn.addEventListener("click", () => editRecord(rec.id));
      }
      delBtn.addEventListener("click", () => deleteRecord(rec.id));

      tdOps.appendChild(editBtn);
      tdOps.appendChild(delBtn);
      tr.appendChild(tdOps);

      const displayAmount = rec.amount; // 所有金额都显示为正数

      addCell(tr, rec.category);
      addCell(tr, rec.accountType);
      addCell(tr, displayAmount.toFixed(2));
      addCell(tr, rec.currency || "");
      addCell(tr, rec.recordDate || "");
      addCell(tr, rec.occurDate || "");
      addCell(tr, rec.note || "");
      const srcTd = addCell(tr, rec.source || "");
      if (rec.source && rec.source.startsWith("自动")) {
        srcTd.classList.add("auto");
      }

      recordsTbody.appendChild(tr);
    });
  }

  function editRecord(id) {
    const rec = records.find(r => r.id === id);
    if (!rec) return;

    categoryEl.value = rec.category;
    accountTypeEl.value = rec.accountType;
    amountEl.value = rec.amount;
    currencyEl.value = rec.currency;
    recordDateEl.value = rec.recordDate;
    occurDateEl.value = rec.occurDate;
    noteEl.value = rec.note;
    syncCategoryForAccountType();

    if (rec.source === "手动" && typeof rec.groupId === "number") {
      records = records.filter(r => r.groupId !== rec.groupId);
    } else {
      records = records.filter(r => r.id !== id);
    }

    renderTable();
    recomputeSummary();
    saveState();
  }

  function deleteRecord(id) {
    const rec = records.find(r => r.id === id);
    if (!rec) return;

    if (rec.source === "手动" && typeof rec.groupId === "number") {
      // 删除手动记录时，把同组的自动记录一并删除
      records = records.filter(r => r.groupId !== rec.groupId);
    } else {
      records = records.filter(r => r.id !== id);
    }

    renderTable();
    recomputeSummary();
    saveState();
  }

  // ------- 事件 -------

  entryForm.addEventListener("submit", function(e) {
    e.preventDefault();

    if (
      (accountTypeEl.value === "日信" || accountTypeEl.value === "中信") &&
      categoryEl.value === "入"
    ) {
      alert("信用卡（日信/中信）手动录入时只能选择“出”。“入”记录请通过自动转记生成。");
      return;
    }

    const amount = parseFloat(amountEl.value);
    if (isNaN(amount) || amount <= 0) return;

    const formData = {
      category: categoryEl.value,
      accountType: accountTypeEl.value,
      amount: amount,
      currency: currencyEl.value || "JPY",
      recordDate: recordDateEl.value || todayStr(),
      occurDate: occurDateEl.value || todayStr(),
      note: noteEl.value || "",
      source: "手动"
    };
    addRecordWithRules(formData);
    renderTable();
    recomputeSummary();
    saveState();
  });

  resetFormBtn.addEventListener("click", function() {
    entryForm.reset();
    recordDateEl.value = todayStr();
    occurDateEl.value = todayStr();
    currencyEl.value = "JPY";
    syncCategoryForAccountType();
  });

  baseCurrencyInput.addEventListener("input", () => {
    const v = baseCurrencyInput.value || "JPY";
    baseCurrencyLabel.textContent = v;
    baseCurrencyInline.textContent = v;

    manualRates = {};
    renderManualRateList();

    fetchAutoRates();
    recomputeSummary();
    saveState();
  });

  rateModeRadios.forEach(r => r.addEventListener("change", () => {
    updateRateModeUI();
    recomputeSummary();
    saveState();
  }));

  addManualRateBtn.addEventListener("click", () => {
    const cur = (manualCurrencyInput.value || "").trim();
    const rate = parseFloat(manualRateInput.value);
    if (!cur || isNaN(rate) || rate <= 0) return;

    if (cur.toUpperCase() === (baseCurrencyInput.value || "JPY").toUpperCase()) {
      alert("基准货币本身的汇率固定为 1，无需手动设置。");
      return;
    }

    manualRates[cur.toUpperCase()] = rate;
    manualCurrencyInput.value = "";
    manualRateInput.value = "";
    renderManualRateList();
    recomputeSummary();
    saveState();
  });

  exportBtn.addEventListener("click", () => {
    const header = ["category","recordDate","occurDate","amount","accountType","note","currency"];
    const lines = [header.join(",")];

    records.forEach(rec => {
      const row = [
        rec.category,
        rec.recordDate || "",
        rec.occurDate || "",
        rec.amount,
        rec.accountType,
        rec.note || "",
        rec.currency || ""
      ];
      lines.push(row.join(","));
    });

    const blob = new Blob([lines.join("\r\n")], {type: "text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "records.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  importFile.addEventListener("change", () => {
    const file = importFile.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(evt) {
      const text = evt.target.result;
      if (!text) return;
      const lines = text.split(/\r?\n/).filter(Boolean);
      if (lines.length <= 1) return;

      const header = lines[0].split(",");
      const idx = (name) => header.indexOf(name);

      const idxCategory = idx("category");
      const idxRecordDate = idx("recordDate");
      const idxOccurDate = idx("occurDate");
      const idxAmount = idx("amount");
      const idxAccountType = idx("accountType");
      const idxNote = idx("note");
      const idxCurrency = idx("currency");

      for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(",");
        if (!cols.length) continue;
        const amount = parseFloat(cols[idxAmount]);
        if (isNaN(amount)) continue;

        const rec = {
          category: cols[idxCategory],
          recordDate: cols[idxRecordDate],
          occurDate: cols[idxOccurDate],
          amount: amount,
          accountType: cols[idxAccountType],
          note: cols[idxNote],
          currency: cols[idxCurrency],
          source: "导入"
        };
        addRecord(rec); // 导入的不带 groupId
      }

      renderTable();
      recomputeSummary();
      saveState();
      importFile.value = "";
    };
    reader.readAsText(file, "utf-8");
  });

  if (summaryMonthEl) {
    summaryMonthEl.addEventListener("input", () => {
      recomputeSummary();
      saveState();
    });
  }

  // ------- 初始化 -------
  syncCategoryForAccountType();
  loadState();
  renderManualRateList();
  updateRateModeUI();
  renderTable();
  recomputeSummary();
  fetchAutoRates();
})();
</script>
</body>
</html>
